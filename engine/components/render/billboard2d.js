/**
 * The Render Engine
 * BillboardComponent
 *
 * @fileoverview A render component which will render the contents of
 *               a generated image until the contents are updated.
 *
 * @author: Brett Fattori (brettf@renderengine.com)
 * @author: $Author$
 * @version: $Revision$
 *
 * Copyright (c) 2010 Brett Fattori (brettf@renderengine.com)
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *
 */

// The class this file defines and its required classes
R.Engine.define({
	"class": "R.components.render.Billboard2D",
	"requires": [
		"R.components.Render",
		"R.rendercontexts.CanvasContext",
		"R.text.AbstractTextRenderer",
		"R.math.Point2D"
	]
});

/**
 * @class The billboard component renders the contents of an image which
 *        was generated by a linked render component.  When the contents
 *        of the linked component are re-rendered, the contents of the
 *        image are updated.  The best usage of this component is for infrequently
 *        changing vector drawn objects.  For example:
 *        <pre>
 *  constructor: function(size, position, pWidth, pHeight) {
 *     this.base("Spaceroid");
 *
 *     // Add components to move and draw the asteroid
 *     this.add(R.components.Mover2D.create("move"));
 *     this.add(R.components.Billboard2D.create("draw", R.components.Vector2D.create("vector")));
 *     this.add(R.components.Collider.create("collider", Spaceroids.collisionModel));
 *        </pre>
 *        Accessing the <tt>R.components.Vector2D</tt> within the <tt>R.components.Billboard2D</tt>
 *        is as simple as calling {@link #getComponent}.  If the contents of the linked
 *        component are updated, you will need to call {@link #regenerate} to recreate the
 *        billboard image.
 *
 *
 * @param name {String} The name of the component
 * @param priority {Number} The priority of the component between 0.0 and 1.0
 * @constructor
 * @extends R.components.Render
 * @description Creates a 2d billboard component.
 */
R.components.render.Billboard2D = function() {
	return R.components.Render.extend(/** @scope R.components.render.Billboard2D.prototype */{

   billboard: null,
   mode: null,
   renderComponent: null,
	hostRect: null,

   /**
    * @private
    */
   constructor: function(name, renderComponent, priority) {
		Assert(renderComponent instanceof R.components.Render ||
				 renderComponent instanceof R.text.AbstractTextRenderer, "Attempt to assign a non-render component to a billboard component");
      this.base(name, priority || 0.1);
      this.billboard = $("<img src='' width='1' height='1'/>");
      this.mode = R.components.render.Billboard2D.REDRAW;
      this.renderComponent = renderComponent;
		
      // All billboard components share the same temporary context
      if (R.components.render.Billboard2D.tempContext == null) {
         // TODO: At some point it would be good to mimic the
         // context to which the component is rendering 
         R.components.render.Billboard2D.tempContext = R.rendercontexts.CanvasContext.create("billboardTemp", 800, 800);
         if (typeof FlashCanvas != "undefined") {
            FlashCanvas.initElement(R.components.render.Billboard2D.tempContext.getSurface());
         }
      }
   },

	/**
	 * Destroy the object
	 */
	destroy: function() {
		this.renderComponent.destroy();
		this.base();
	},

   /**
    * Releases the component back into the object pool. See {@link R.engine.PooledObject#release}
    * for more information.
    */
   release: function() {
      this.base();
      this.billboard = null;
      this.mode = null;
      this.renderComponent = null;
   },

   /**
    * Establishes the link between this component and its host object.
    * When you assign components to a host object, it will call this method
    * so that each component can refer to its host object, the same way
    * a host object can refer to a component with {@link R.engine.GameObject#getComponent}.
    *
    * @param hostObject {R.engine.GameObject} The object which hosts this component
    */
   setHostObject: function(hostObject) {
      this.renderComponent.setHostObject(hostObject);
      this.base(hostObject);
   },

	/**
	 * Call this method when the linked render component has been updated
	 * to force the billboard to be redrawn.
	 */
   regenerate: function() {
      this.mode = R.components.render.Billboard2D.REDRAW;
		this.hostRect = null;
		this.getHostObject().markDirty();
   },

	/**
	 * Get the linked render component.
	 * @return {R.components.Render}
	 */
   getComponent: function() {
      return this.renderComponent;
   },

   /**
    * Draws the contents of the billboard to the render context.  This
    * component operates in one of two modes.  When the contents of the
    * subclassed component are redrawing, a temporary render context is created
    * to which the component renders.  The second mode is where the contents
    * of the context from the first mode are rendered instead of performing
    * all of the operations required to render the component.  This component
    * is only good if the contents don't change often.
    *
    * @param renderContext {R.rendercontexts.AbstractRenderContext} The rendering context
    * @param time {Number} The engine time in milliseconds
    */
   execute: function(renderContext, time) {
      if (!this.base(renderContext, time)) {
         return;
      }
      
	  	// Get the host objects bounding box
		var hostBox = this.getHostObject().getBoundingBox();
		var o = R.math.Point2D.create(this.getHostObject().getOrigin());
		
		if (this.mode == R.components.render.Billboard2D.REDRAW) {
			// Provide a temporary context which is used to render the contents into
			Assert((R.components.render.Billboard2D.tempContext != null), "R.components.render.Billboard2D temporary context is not defined!");
			
			// Clear the temporary context and render the associated component to it
			R.components.render.Billboard2D.tempContext.getElement().width = hostBox.w + 1;
			R.components.render.Billboard2D.tempContext.getElement().height = hostBox.h + 1;
			R.components.render.Billboard2D.tempContext.reset();
			var p = R.math.Point2D.create(0,0);
			p.add(o);
			R.components.render.Billboard2D.tempContext.setPosition(p);
			p.destroy();
			this.renderComponent.execute(R.components.render.Billboard2D.tempContext, time);
			
			// Extract the rendered image
			this.billboard.attr("src", R.components.render.Billboard2D.tempContext.getDataURL()).attr("width", hostBox.w).attr("height", hostBox.h + 1);
			this.mode = R.components.render.Billboard2D.NORMAL;
		}
		
		// Render the billboard.  If the bounding box's origin is negative in
		// either X or Y, we'll need to move the transformation there before rendering the object
		this.transformOrigin(renderContext, true);
		try {
			renderContext.drawImage(this.getHostObject().getBoundingBox(), this.billboard[0]);
		} 
		catch (ex) {
			// TODO: Find a better way to perform this operation since try/catch is SLOW
			// It appears that Firefox might not have a full image rendered, so calling
			// drawImage fails with a component exception.  To abate this possible issue,
			// we try the call and catch the failure...	
		}

      /* pragma:DEBUG_START */
      // Debug the billboard image box
      if (R.Engine.getDebugMode())
      {
         renderContext.setLineStyle("green");
         renderContext.drawRectangle(this.getHostObject().getBoundingBox());
      }
      /* pragma:DEBUG_END */

		this.transformOrigin(renderContext, false);
		o.destroy();
   }

}, /** @scope R.components.render.Billboard2D.prototype */{ 

   /**
    * Get the class name of this object
    *
    * @return {String} "R.components.render.Billboard2D"
    */
   getClassName: function() {
      return "R.components.render.Billboard2D";
   },

   /**
    * The component will render to a temporary context from which the
    * actual content will be rendered.
    * @type {Number}
    */
   REDRAW: 0,

   /**
    * The component will render the contents of the billboard.
    * @type {Number}
    */
   NORMAL: 1,
   
   /**
    * A temporary context to which all billboards will render their
    * bitmaps.
    * @private
    */
   tempContext: null

});
}